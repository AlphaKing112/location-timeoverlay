<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Overlay</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      color: white;
      background: transparent;
    }
    #overlay {
      padding: 10px;
      font-weight: bold;
      text-shadow: 2px 2px 6px #000;
      user-select: none;
      font-size: 20px;
      line-height: 1.6;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .emoji {
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div class="row"><span class="emoji">🕒</span><span id="time">--:--</span></div>
    <div class="row"><span class="emoji">🗺️</span><span id="location">Loading...</span></div>
    <div class="row"><span class="emoji">🌥</span><span id="condition">--</span></div>
    <div class="row"><span class="emoji">🌡</span><span id="temperature">--°F</span></div>
  </div>

 <script>
  const channel = new BroadcastChannel("location_channel");
  let currentCity = "Los Angeles"; // fallback

  channel.onmessage = (event) => {
    if (event.data.type === "city-updated" && event.data.city) {
      currentCity = event.data.city;
      updateOverlay();
    }
  };

  async function updateOverlay() {
    const timeEl = document.getElementById("time");
    const locationEl = document.getElementById("location");
    const conditionEl = document.getElementById("condition");
    const tempEl = document.getElementById("temperature");

    const openWeatherApiKey = "e9b4f16a2a8f9f682f961e4c5c9abbe2";

    try {
      // Get coordinates
      const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(currentCity)}&limit=1&appid=${openWeatherApiKey}`);
      const geoData = await geoRes.json();
      if (!geoData[0]) throw new Error("Invalid location");

      const { lat, lon, name: region, country } = geoData[0];

      // Get weather
      const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=imperial&appid=${openWeatherApiKey}`);
      const weatherData = await weatherRes.json();
      const tempF = Math.round(weatherData.main.temp);
      const condition = capitalize(weatherData.weather[0].description);
      const timezone = weatherData.timezone; // in seconds offset from UTC

      // Convert timezone offset to IANA string fallback
      const ianaZone = offsetToIana(timezone);

      setInterval(() => {
        const now = new Date();
        const formattedTime = new Intl.DateTimeFormat("en-US", {
          hour: "numeric",
          minute: "2-digit",
          second: "2-digit",
          hour12: true,
          timeZone: ianaZone
        }).format(now);
        timeEl.textContent = formattedTime;
      }, 1000);

      locationEl.textContent = `${region}, ${country}`;
      conditionEl.textContent = condition;
      tempEl.textContent = `${tempF}°F`;
    } catch (e) {
      console.error("Error updating overlay:", e);
      locationEl.textContent = "Unable to load location.";
      conditionEl.textContent = "--";
      tempEl.textContent = "--°F";
    }

    function capitalize(text) {
      return text.charAt(0).toUpperCase() + text.slice(1);
    }

    function offsetToIana(offsetSec) {
      const offsetHours = offsetSec / 3600;
      const sign = offsetHours >= 0 ? "-" : "+";
      const padded = String(Math.abs(offsetHours)).padStart(2, "0");
      return `Etc/GMT${sign}${padded}`;
    }
  }

  updateOverlay();
</script>

</body>
</html>
