<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Overlay</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      color: white;
      background: transparent;
    }
    #overlay {
      padding: 10px;
      font-weight: bold;
      text-shadow: 2px 2px 6px #000;
      user-select: none;
      font-size: 20px;
      line-height: 1.6;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .emoji {
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div class="row"><span class="emoji">🕒</span><span id="time">--:--</span></div>
    <div class="row"><span class="emoji">🗺️</span><span id="location">Loading...</span></div>
    <div class="row"><span class="emoji">🌥</span><span id="condition">--</span></div>
    <div class="row"><span class="emoji">🌡</span><span id="temperature">--°F</span></div>
  </div>

 <script>
  let currentCity = "Los Angeles"; // fallback
  let currentCountry = "USA";      // fallback
  let currentTimezone = "America/Los_Angeles"; // fallback

  const channel = new BroadcastChannel("location_channel");
  channel.onmessage = (event) => {
    if (event.data.type === "city-updated" && event.data.city) {
      currentCity = event.data.city;
      updateOverlay();
    }
  };

  async function updateOverlay() {
    const timeEl = document.getElementById("time");
    const locationEl = document.getElementById("location");
    const conditionEl = document.getElementById("condition");
    const tempEl = document.getElementById("temperature");

    const openWeatherApiKey = "e9b4f16a2a8f9f682f961e4c5c9abbe2";

    const countryAbbreviations = {
      "US": "USA", "GB": "UK", "CA": "CAN",
      "AU": "AUS", "DE": "DEU", "FR": "FRA", "IN": "IND"
    };

    try {
      const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(currentCity)}&limit=1&appid=${openWeatherApiKey}`);
      const geoData = await geoRes.json();

      if (!geoData[0]) throw new Error("Invalid location");

      const lat = geoData[0].lat;
      const lon = geoData[0].lon;
      const region = geoData[0].name;
      const country = geoData[0].country;
      const tzRes = await fetch(`https://worldtimeapi.org/api/timezone`);
      const zones = await tzRes.json();

      // Just guess the timezone using city name match (better: use a better API)
      const matchingZone = zones.find(z => z.toLowerCase().includes(currentCity.toLowerCase())) || "America/Los_Angeles";

      const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=imperial&appid=${openWeatherApiKey}`);
      const weatherData = await weatherRes.json();

      const tempF = Math.round(weatherData.main.temp);
      const condition = capitalize(weatherData.weather[0].description);

      locationEl.textContent = `${region}, ${countryAbbreviations[country] || country}`;
      conditionEl.textContent = condition;
      tempEl.textContent = `${tempF}°F`;

      setInterval(() => {
        const now = new Date();
        const formattedTime = new Intl.DateTimeFormat("en-US", {
          hour: "numeric",
          minute: "2-digit",
          second: "2-digit",
          hour12: true,
          timeZone: matchingZone
        }).format(now);
        timeEl.textContent = formattedTime;
      }, 1000);

    } catch (e) {
      locationEl.textContent = "Unable to load location.";
      conditionEl.textContent = "--";
      tempEl.textContent = "--°F";
    }

    function capitalize(text) {
      return text.charAt(0).toUpperCase() + text.slice(1);
    }
  }

  // Initial load
  updateOverlay();
</script>
</body>
</html>
